@model AbcBooks.Models.ViewModels.OrderViewModel

@{
	ViewData["Title"] = "Details";
}

@if (TempData["TrackingIdOrCarrierIsEmpty"] is not null)
{
	<div class="alert alert-dismissible alert-danger">
		<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		<strong>@TempData["TrackingIdOrCarrierIsEmpty"]</strong>
	</div>
}

<form method="post">
	<input asp-for="Order.Id" hidden />
	<br />
	<div class="container">
		<div class="card">
			<div class="card-header bg-primary text-light ml-0">
				<div class="container row">
					<div class="col-12 d-none d-md-block col-md-6 pb-1">
						Order Summary
					</div>
					<div class="col-12 col-md-4 offset-md-2 text-right">
						<a asp-action="Index" class="btn btn-outline-light form-control btn-sm">Back to Orders</a>
					</div>
				</div>
			</div>
			<div class="card-body">
				<div class="container rounded p-2">
					<div class="row">
						<div class="col-12 col-lg-6 pb-4">
							<div class="row">
								<h4 class="d-flex justify-content-between align-items-center mb-3">
									<span class="text-primary">Shipping Details:</span>
								</h4>
							</div>
							<div class="row my-1">
								<div class="col-3">First Name</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) && Model.Order.OrderStatus is not ProjectConstants.STATUS_DELIVERED && Model.Order.OrderStatus is not ProjectConstants.STATUS_CANCELLED)
									{
										<input asp-for="Order.ShippingAddress.FirstName" type="text" class="form-control" />
										<span asp-validation-for="Order.ShippingAddress.FirstName" class="text-danger"></span>
									}
									else
									{
										<input disabled asp-for="Order.ShippingAddress.FirstName" readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Last Name</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) && Model.Order.OrderStatus is not ProjectConstants.STATUS_DELIVERED && Model.Order.OrderStatus is not ProjectConstants.STATUS_CANCELLED)
									{
										<input asp-for="Order.ShippingAddress.LastName" type="text" class="form-control" />
										<span asp-validation-for="Order.ShippingAddress.LastName" class="text-danger"></span>
									}
									else
									{
										<input disabled asp-for="Order.ShippingAddress.LastName" readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Phone</div>
								<div class="col-9">
									<input disabled asp-for="Order.ShippingAddress.PhoneNumber" readonly type="text" class="form-control" />
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">House No./Name</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) && Model.Order.OrderStatus is not ProjectConstants.STATUS_DELIVERED && Model.Order.OrderStatus is not ProjectConstants.STATUS_CANCELLED)
									{
										<input asp-for="Order.ShippingAddress.HouseNameOrNumber" type="text" class="form-control" />
										<span asp-validation-for="Order.ShippingAddress.HouseNameOrNumber" class="text-danger"></span>
									}
									else
									{
										<input asp-for="Order.ShippingAddress.HouseNameOrNumber" disabled readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Street</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) && Model.Order.OrderStatus is not ProjectConstants.STATUS_DELIVERED && Model.Order.OrderStatus is not ProjectConstants.STATUS_CANCELLED)
									{
										<input asp-for="Order.ShippingAddress.StreetAddress" type="text" class="form-control" />
										<span asp-validation-for="Order.ShippingAddress.StreetAddress" class="text-danger"></span>
									}
									else
									{
										<input asp-for="Order.ShippingAddress.StreetAddress" disabled readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">City</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) && Model.Order.OrderStatus is not ProjectConstants.STATUS_DELIVERED && Model.Order.OrderStatus is not ProjectConstants.STATUS_CANCELLED)
									{
										<input asp-for="Order.ShippingAddress.City" type="text" class="form-control" />
										<span asp-validation-for="Order.ShippingAddress.City" class="text-danger"></span>
									}
									else
									{
										<input asp-for="Order.ShippingAddress.City" disabled readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">District</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) && Model.Order.OrderStatus is not ProjectConstants.STATUS_DELIVERED && Model.Order.OrderStatus is not ProjectConstants.STATUS_CANCELLED)
									{
										<input asp-for="Order.ShippingAddress.District" type="text" class="form-control" />
										<span asp-validation-for="Order.ShippingAddress.District" class="text-danger"></span>
									}
									else
									{
										<input asp-for="Order.ShippingAddress.District" disabled readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">PIN</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) && Model.Order.OrderStatus is not ProjectConstants.STATUS_DELIVERED && Model.Order.OrderStatus is not ProjectConstants.STATUS_CANCELLED)
									{
										<input asp-for="Order.ShippingAddress.PinCode" type="text" class="form-control" />
										<span asp-validation-for="Order.ShippingAddress.PinCode" class="text-danger"></span>
									}
									else
									{
										<input asp-for="Order.ShippingAddress.PinCode" readonly disabled type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">State</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) && Model.Order.OrderStatus is not ProjectConstants.STATUS_DELIVERED && Model.Order.OrderStatus is not ProjectConstants.STATUS_CANCELLED)
									{
										<input asp-for="Order.ShippingAddress.State" type="text" class="form-control" />
										<span asp-validation-for="Order.ShippingAddress.State" class="text-danger"></span>
									}
									else
									{
										<input asp-for="Order.ShippingAddress.State" disabled readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Email</div>
								<div class="col-9">
									<input disabled asp-for="Order.ApplicationUser.Email" readonly type="text" class="form-control" />
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Order Date</div>
								<div class="col-9">

									<input disabled value="@Model.Order.OrderDate.ToShortDateString()" readonly type="text" class="form-control" />

								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Carrier</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) &&
											(Model.Order.OrderStatus == ProjectConstants.STATUS_PENDING || Model.Order.OrderStatus == ProjectConstants.STATUS_IN_PROCESS || Model.Order.OrderStatus == ProjectConstants.STATUS_APPROVED))
									{
										<input asp-for="Order.Carrier" id="carrier" type="text" class="form-control" />
									}
									else
									{
										<input asp-for="Order.Carrier" disabled readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Tracking ID</div>
								<div class="col-9">
									@if (User.IsInRole(ProjectConstants.ADMIN) &&
											(Model.Order.OrderStatus == ProjectConstants.STATUS_PENDING || Model.Order.OrderStatus == ProjectConstants.STATUS_IN_PROCESS || Model.Order.OrderStatus == ProjectConstants.STATUS_APPROVED))
									{
										<input asp-for="Order.TrackingNumber" id="trackingNumber" type="text" class="form-control" />
									}
									else
									{
										<input asp-for="Order.TrackingNumber" disabled readonly type="text" class="form-control" />
									}
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Shipping Date</div>
								<div class="col-9">
									<input disabled value="@Model.Order.ShippingDate.ToShortDateString()" type="text" readonly class="form-control" />
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Payment Method</div>
								<div class="col-9">
									<input disabled asp-for="Order.PaymentMethod" class="form-control" />
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Payment Status</div>
								<div class="col-9">
									<input disabled asp-for="Order.PaymentStatus" type="text" readonly class="form-control" />
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Payment Date</div>
								<div class="col-9">
									<input disabled value="@Model.Order.PaymentDate.ToShortDateString()" type="text" readonly class="form-control" />
								</div>
							</div>
							<div class="row my-1">
								<div class="col-3">Delivery Date</div>
								<div class="col-9">
									<input disabled value="@Model.Order.DeliveryDate.ToShortDateString()" type="text" readonly class="form-control" />
								</div>
							</div>
							@*@if (User.IsInRole(ProjectConstants.ADMIN) &&
									(Model.Order.OrderStatus == ProjectConstants.STATUS_PENDING) || (Model.Order.OrderStatus == ProjectConstants.STATUS_APPROVED))
							{
								<input type="submit" asp-action="UpdateOrderDetail" class="btn btn-warning form-control my-1" value="Update Order Details" />
							}*@
						</div>
						<div class="col-12 col-lg-5 offset-lg-1">
							<h4 class="d-flex justify-content-between align-items-center mb-3">
								<span class="text-primary">Order Summary</span>
							</h4>
							<label class="btn btn-outline-info form-control my-2">Order Status - @Model.Order.OrderStatus</label>

							<ul class="list-group mb-3">
								@foreach (var detail in Model.OrderDetails)
								{
									<li class="list-group-item d-flex justify-content-between p-2">
										<div class="row container">
											<div class="col-8">

												<h6 class="my-0 text-primary">@detail.Product.Title</h6>
												<small class="text-muted">Price : @detail.Price.ToString("c")</small><br />
												<small class="text-muted">Quantity : @detail.Quantity</small>
											</div>
											<div class="col-4 text-end">
												<p class="text-success">@((detail.Quantity * detail.Price).ToString("c"))</p>
											</div>
										</div>
									</li>
								}
								<li class="list-group-item bg-info">
									<div class="row container">
										<div class="col-6">
											<h5 class="text-white">TOTAL </h5>
										</div>
										<div class="col-6 text-end">
											<h5 class="text-white">@Model.Order.OrderTotal.ToString("c")</h5>
										</div>
									</div>
								</li>
							</ul>

							@if (User.IsInRole(ProjectConstants.ADMIN))
							{
								@if (Model.Order.OrderStatus == ProjectConstants.STATUS_PENDING)
								{
									<input asp-action="ConfirmOrder" type="submit" class="btn btn-dark form-control my-1" value="Confirm Order" />
								}
								else if (Model.Order.OrderStatus == ProjectConstants.STATUS_IN_PROCESS || Model.Order.OrderStatus == ProjectConstants.STATUS_APPROVED)
								{
									<input asp-action="ShipOrder" type="submit" class="btn btn-dark form-control my-1" value="Ship Order" />
								}
								else if (Model.Order.OrderStatus == ProjectConstants.STATUS_SHIPPED)
								{
									@if (Model.Order.PaymentMethod == ProjectConstants.PAYMENT_METHOD_CASH_ON_DELIVERY)
									{
										<input asp-action="CashOnDelivery" type="submit" class="btn btn-success form-control my-1" value="Pay Cash" />
										<input disabled type="submit" class="btn btn-success form-control my-1" value="Other Payment Methods" />
									}
									else
									{
										<input asp-action="OrderDelivered" type="submit" class="btn btn-success form-control my-1" value="Delivered" />
									}
								}
							}

							@if (User.IsInRole(ProjectConstants.ADMIN))
							{
								@if (Model.Order.OrderStatus == ProjectConstants.STATUS_SHIPPED || Model.Order.OrderStatus == ProjectConstants.STATUS_PENDING || Model.Order.OrderStatus == ProjectConstants.STATUS_IN_PROCESS || Model.Order.OrderStatus == ProjectConstants.STATUS_APPROVED)
								{
									<input asp-action="CancelOrder" type="submit" class="btn btn-danger form-control	my-1" value="Cancel Order" />
								}
							}

							@if (User.IsInRole(ProjectConstants.CUSTOMER))
							{
								@if (Model.Order.OrderStatus == ProjectConstants.STATUS_PENDING || Model.Order.OrderStatus == ProjectConstants.STATUS_IN_PROCESS || Model.Order.OrderStatus == ProjectConstants.STATUS_APPROVED)
								{
									<input asp-action="CancelOrder" type="submit" class="btn btn-danger form-control	my-1" value="Cancel Order" />
								}
							}

							@if (Model.Order.OrderStatus is ProjectConstants.STATUS_DELIVERED && User.IsInRole(ProjectConstants.CUSTOMER) && (DateTime.Now - Model.Order.DeliveryDate < TimeSpan.FromDays(7)))
							{
								<input asp-action="ReturnOrder" type="submit" class="btn btn-danger form-control my-1" value="Return" />
								<label class="btn btn-outline-danger form-control my-2">Return Availabe only till @(Model.Order.DeliveryDate + TimeSpan.FromDays(7))</label>
							}

							@if (User.IsInRole(ProjectConstants.CUSTOMER))
							{
								@if (Model.Order.OrderStatus is ProjectConstants.STATUS_RETURN_REQUESTED)
								{
									<label class="btn btn-outline-danger form-control my-2">Return Requested</label>
								}
								else if (Model.Order.OrderStatus is ProjectConstants.STATUS_RETURN_APPROVED)
								{
									<label class="btn btn-outline-success form-control my-2">Return Request Approved</label>
								}
								else if (Model.Order.OrderStatus is ProjectConstants.STATUS_RETURN_REJECTED)
								{
									<label class="btn btn-outline-danger form-control my-2">Return Request Declined</label>
								}
								else if (Model.Order.OrderStatus is ProjectConstants.STATUS_RETURN_COMPLETE)
								{
									<label class="btn btn-outline-danger form-control my-2">Order Returned And Refunded</label>
								}
							}

							@if (User.IsInRole(ProjectConstants.ADMIN))
							{
								@if (Model.Order.OrderStatus is ProjectConstants.STATUS_RETURN_REQUESTED)
								{
									<input asp-action="ApproveReturn" type="submit" class="btn btn-success form-control my-1" value="Approve Return" />
									<input asp-action="DeclineReturn" type="submit" class="btn btn-danger form-control my-1" value="Decline Return" />
								}
								else if (Model.Order.OrderStatus is ProjectConstants.STATUS_RETURN_APPROVED)
								{
									<input asp-action="RefundToWallet" type="submit" class="btn btn-success form-control my-1" value="Refund To Wallet" />
								}
								else if (Model.Order.OrderStatus is ProjectConstants.STATUS_RETURN_COMPLETE)
								{
									<label class="btn btn-outline-danger form-control my-2">Order Returned And Refunded</label>
								}
							}

							@if (User.IsInRole(ProjectConstants.ADMIN))
							{
								<a class="btn btn-secondary form-control my-2" asp-controller="Download" asp-action="DownloadOrderInvoice" asp-route-orderId="@Model.Order.Id">Download Invoice</a>
							}
							else
							{
								if (Model.Order.OrderStatus != ProjectConstants.STATUS_CANCELLED && Model.Order.OrderStatus != ProjectConstants.STATUS_RETURN_COMPLETE)
								{
									<a class="btn btn-secondary form-control my-2" asp-controller="Download" asp-action="DownloadOrderInvoice" asp-route-orderId="@Model.Order.Id">Download Invoice</a>
								}
							}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</form>

@section Scripts {
	@{
		<partial name="_ValidationScriptsPartial" />
	}
}